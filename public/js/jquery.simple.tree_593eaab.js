$.fn.simpleTree=function(e){return this.each(function(){var t=this,s=$(".root",this),o=$("#root0",this),a=!1,i=!1,n=!1,l=!1,r=!1,c=Array();t.option={drag:!0,animate:!1,autoclose:!1,speed:"fast",afterAjax:!1,afterMove:!1,afterClick:!1,afterDblClick:!1,afterContextMenu:!1,docToFolderConvert:!1},t.option=$.extend(t.option,e),$.extend(this,{getSelected:function(){return $("span.active",this).parent()}}),t.closeNearby=function(e){$(e).siblings().filter(".folder-open, .folder-open-last").each(function(){var e=$(">ul",this),s=this.className;this.className=s.replace("open","close"),t.option.animate?e.animate({height:"toggle"},t.option.speed):e.hide()})},t.nodeToggle=function(e){var s=$(">ul",e);s.is(":visible")?(e.className=e.className.replace("open","close"),t.option.animate?s.animate({height:"toggle"},t.option.speed):s.hide()):(e.className&&(e.className=e.className.replace("close","open")),t.option.animate?s.animate({height:"toggle"},t.option.speed,function(){t.option.autoclose&&t.closeNearby(e),s.is(".ajax")&&t.setAjaxNodes(s,e.id)}):(s.show(),t.option.autoclose&&t.closeNearby(e),s.is(".ajax")&&t.setAjaxNodes(s,e.id)))},t.setAjaxNodes=function(e,s,o){if(-1==$.inArray(s,c)){c[c.length]=s;var a=$.trim($(">li",e).text());a&&a.indexOf("url:")&&(a=$.trim(a.replace(/.*\{url:(.*)\}/i,"$1")),$.ajax({type:"GET",url:a,contentType:"html",cache:!1,success:function(s){e.removeAttr("class"),e.html(s),$.extend(e,{url:a}),t.setTreeNodes(e,!0),"function"==typeof t.option.afterAjax&&t.option.afterAjax(e),"function"==typeof o&&o(e)}}))}},t.setTreeNodes=function(e,s){e=s?e.parent():e,$("li>span",e).addClass("text").bind("selectstart",function(){return!1}).click(function(){return $(".active",t).attr("class","text"),"text"==this.className&&(this.className="active"),"function"==typeof t.option.afterClick&&t.option.afterClick($(this).parent()),!1}).dblclick(function(){return a=!1,t.nodeToggle($(this).parent().get(0)),"function"==typeof t.option.afterDblClick&&t.option.afterDblClick($(this).parent()),!1}).bind("contextmenu",function(){return $(".active",t).attr("class","text"),"text"==this.className&&(this.className="active"),"function"==typeof t.option.afterContextMenu&&t.option.afterContextMenu($(this).parent()),!1}).mousedown(function(){a=!0,cloneNode=$(this).parent().clone();var e=$(this).parent();return t.option.drag&&($(">ul",cloneNode).hide(),$("body").append('<div id="drag_container"><ul></ul></div>'),$("#drag_container").hide().css({opacity:"0.8"}),$("#drag_container >ul").append(cloneNode),$("<img>").attr({id:"tree_plus",src:"images/plus.gif"}).css({width:"7px",display:"block",position:"absolute",left:"5px",top:"5px",display:"none"}).appendTo("body"),$(document).bind("mousemove",{LI:e},t.dragStart).bind("mouseup",t.dragEnd)),!1}).mouseup(function(){a&&i&&l&&t.moveNodeToFolder($(this).parent()),t.eventDestroy()}),$("li",e).each(function(){var e=this.className,s=!1,o=$(">ul",this);if(o.size()>0){var a="folder-";e&&e.indexOf("open")>=0?(a+="open",s=!0):a+="close",this.className=a+($(this).is(":last-child")?"-last":""),(!s||e.indexOf("ajax")>=0)&&o.hide(),t.setTrigger(this)}else{var a="doc";this.className=a+($(this).is(":last-child")?"-last":"")}}).before('<li class="line">&nbsp;</li>').filter(":last-child").after('<li class="line-last"></li>'),t.setEventLine($(".line, .line-last",e))},t.setTrigger=function(e){$(">span",e).before('<img class="trigger" src="/public/img/spacer.gif" border=0>');var s=$(">.trigger",e);s.click(function(){t.nodeToggle(e)}),$.browser.msie||s.css("float","left")},t.dragStart=function(e){var s=$(e.data.LI);if(a){i=!0,r&&clearTimeout(r),$("#drag_container:not(:visible)")&&($("#drag_container").show(),s.prev(".line").hide(),l=s),$("#drag_container").css({position:"absolute",left:e.pageX+5,top:e.pageY+15}),s.is(":visible")&&s.hide();if("span"==e.target.tagName.toLowerCase()&&-1!=$.inArray(e.target.className,Array("text","active","trigger"))){var o=e.target.parentNode,n=$(o).offset({scroll:!1}),c={x:n.left-3,y:e.pageY-n.top},p=$("#tree_plus").attr("src"),d=$(">ul.ajax",o).size(),u=$(">ul.ajax",o);c.x+=19,c.y=e.pageY-c.y+5,o.className.indexOf("folder-close")>=0&&0==d?(-1!=p.indexOf("minus")&&$("#tree_plus").attr("src","images/plus.gif"),$("#tree_plus").css({left:c.x,top:c.y}).show(),r=setTimeout(function(){o.className=o.className.replace("close","open"),$(">ul",o).show()},700)):o.className.indexOf("folder")>=0&&0==d?(-1!=p.indexOf("minus")&&$("#tree_plus").attr("src","images/plus.gif"),$("#tree_plus").css({left:c.x,top:c.y}).show()):o.className.indexOf("folder-close")>=0&&d>0?(i=!1,$("#tree_plus").attr("src","images/minus.gif"),$("#tree_plus").css({left:c.x,top:c.y}).show(),$(">ul",o).show(),t.setAjaxNodes(u,o.id,function(){o.className=o.className.replace("close","open"),i=!0,$("#tree_plus").attr("src","images/plus.gif"),$("#tree_plus").css({left:c.x,top:c.y}).show()})):t.option.docToFolderConvert?$("#tree_plus").css({left:c.x,top:c.y}).show():$("#tree_plus").hide()}else $("#tree_plus").hide();return!1}return!0},t.dragEnd=function(){r&&clearTimeout(r),t.eventDestroy()},t.setEventLine=function(e){e.mouseover(function(){this.className.indexOf("over")<0&&a&&i&&(this.className=this.className.replace("line","line-over"))}).mouseout(function(){this.className.indexOf("over")>=0&&(this.className=this.className.replace("-over",""))}).mouseup(function(){a&&l&&i&&(n=$(this).parents("li:first"),t.moveNodeToLine(this),t.eventDestroy())})},t.checkNodeIsLast=function(e){if(e.className.indexOf("last")>=0){var t=l.prev().prev();t.size()>0&&(t[0].className+="-last"),e.className=e.className.replace("-last","")}},t.checkLineIsLast=function(e){if(e.className.indexOf("last")>=0){var t=$(e).prev();t.size()>0&&(t[0].className=t[0].className.replace("-last","")),l[0].className+="-last"}},t.eventDestroy=function(){$(document).unbind("mousemove",t.dragStart).unbind("mouseup").unbind("mousedown"),$("#drag_container, #tree_plus").remove(),l&&$(l).show().prev(".line").show(),n=l=a=i=!1},t.convertToFolder=function(e){e[0].className=e[0].className.replace("doc","folder-open"),e.append('<ul><li class="line-last"></li></ul>'),t.setTrigger(e[0]),t.setEventLine($(".line, .line-last",e))},t.convertToDoc=function(e){$(">ul",e).remove(),$("img",e).remove(),e[0].className=e[0].className.replace(/folder-(open|close)/gi,"doc")},t.moveNodeToFolder=function(e){if(!t.option.docToFolderConvert&&-1!=e[0].className.indexOf("doc"))return!0;t.option.docToFolderConvert&&-1!=e[0].className.indexOf("doc")&&t.convertToFolder(e),t.checkNodeIsLast(l[0]);var s=$(">ul >.line-last",e);s.size()>0&&t.moveNodeToLine(s[0])},t.moveNodeToLine=function(e){t.checkNodeIsLast(l[0]),t.checkLineIsLast(e);var s=$(l).parents("li:first"),o=$(l).prev(".line");$(e).before(l),$(l).before(o),e.className=e.className.replace("-over","");var a=$(">ul >li",s).not(".line, .line-last").filter(":visible").size();if(t.option.docToFolderConvert&&0==a?t.convertToDoc(s):0==a&&(s[0].className=s[0].className.replace("open","close"),$(">ul",s).hide()),"text"==$("span:first",l).attr("class")&&($(".active",t).attr("class","text"),$("span:first",l).attr("class","active")),"function"==typeof t.option.afterMove){var i=$(l).prevAll(":not(.line)").size();t.option.afterMove($(e).parents("li:first"),$(l),i)}},t.addNode=function(e,s,o){var a=$('<li><ul><li id="'+e+'"><span>'+s+"</span></li></ul></li>");t.setTreeNodes(a),n=t.getSelected(),l=$(".doc-last",a),t.moveNodeToFolder(n),a.remove(),"function"==typeof o&&o(n,l)},t.delNode=function(e){l=t.getSelected(),t.checkNodeIsLast(l[0]),l.prev().remove(),l.remove(),"function"==typeof e&&e(n)},t.init=function(e){t.setTreeNodes(e,!1),t.nodeToggle(o)},t.init(s)})};